Option Explicit

' Macro pour vérifier 4 champs entre deux fichiers avec config par fichier
Public Sub VerifierChamps()
    Dim cfgWS        As Worksheet
    Dim srcWB        As Workbook, srcWS As Worksheet
    Dim tgtWB        As Workbook, tgtWS As Worksheet
    Dim dict         As Object
    Dim key          As String
    Dim lastRowSrc   As Long, lastRowTgt As Long
    Dim i As Long, j As Long
    
    ' Variables config source
    Dim sourcePath    As String, sourceSheet As String
    Dim srcStartRow   As Long
    Dim srcCols(1 To 4) As String
    ' Variables config cible
    Dim targetPath    As String, targetSheet As String
    Dim tgtStartRow   As Long
    Dim tgtCols(1 To 4) As String
    Dim resultCol     As String
    
    ' --- Lire configuration depuis feuille Config
    On Error Resume Next: Set cfgWS = ThisWorkbook.Sheets("Config"): On Error GoTo 0
    If cfgWS Is Nothing Then MsgBox "Feuille 'Config' introuvable.", vbCritical: Exit Sub
    With cfgWS
        ' Source
        sourcePath  = Trim(.Range("B3").Value)
        sourceSheet = Trim(.Range("B4").Value)
        srcStartRow = CLng(.Range("B5").Value)
        srcCols(1)  = Trim(.Range("B6").Value)
        srcCols(2)  = Trim(.Range("B7").Value)
        srcCols(3)  = Trim(.Range("B8").Value)
        srcCols(4)  = Trim(.Range("B9").Value)
        ' Cible
        targetPath  = Trim(.Range("B10").Value)
        targetSheet = Trim(.Range("B11").Value)
        tgtStartRow = CLng(.Range("B12").Value)
        tgtCols(1)  = Trim(.Range("B13").Value)
        tgtCols(2)  = Trim(.Range("B14").Value)
        tgtCols(3)  = Trim(.Range("B15").Value)
        tgtCols(4)  = Trim(.Range("B16").Value)
        resultCol   = Trim(.Range("B17").Value)
    End With
    ' Valider config
    If sourcePath = "" Or sourceSheet = "" Or srcStartRow < 1 Then
        MsgBox "Paramètres source invalides en B3:B9.", vbCritical: Exit Sub
    End If
    If targetPath = "" Or targetSheet = "" Or tgtStartRow < 1 Or resultCol = "" Then
        MsgBox "Paramètres cible invalides en B10:B17.", vbCritical: Exit Sub
    End If
    
    Set dict = CreateObject("Scripting.Dictionary")
    ' --- Charger source
    On Error Resume Next: Set srcWB = Workbooks.Open(sourcePath, ReadOnly:=True): On Error GoTo 0
    If srcWB Is Nothing Then MsgBox "Impossible d'ouvrir source: " & sourcePath, vbCritical: Exit Sub
    Set srcWS = srcWB.Sheets(sourceSheet)
    If srcWS Is Nothing Then MsgBox "Feuille source introuvable: " & sourceSheet, vbCritical: srcWB.Close False: Exit Sub
    ' Construire dictionnaire clefs source
    lastRowSrc = srcWS.Cells(srcWS.Rows.Count, ColumnLetterToNumber(srcCols(1))).End(xlUp).Row
    For i = srcStartRow To lastRowSrc
        key = ""
        For j = 1 To 4
            key = key & "|" & CStr(srcWS.Cells(i, ColumnLetterToNumber(srcCols(j))).Value)
        Next j
        dict(key) = True
    Next i
    srcWB.Close False
    
    ' --- Ouvrir cible
    On Error Resume Next: Set tgtWB = Workbooks.Open(targetPath): On Error GoTo 0
    If tgtWB Is Nothing Then MsgBox "Impossible d'ouvrir cible: " & targetPath, vbCritical: Exit Sub
    Set tgtWS = tgtWB.Sheets(targetSheet)
    If tgtWS Is Nothing Then MsgBox "Feuille cible introuvable: " & targetSheet, vbCritical: tgtWB.Close False: Exit Sub
    ' Préparer résultat
    lastRowTgt = tgtWS.Cells(tgtWS.Rows.Count, ColumnLetterToNumber(tgtCols(1))).End(xlUp).Row
    If tgtWS.Cells(tgtStartRow - 1, ColumnLetterToNumber(resultCol)).Value = "" Then
        tgtWS.Cells(tgtStartRow - 1, ColumnLetterToNumber(resultCol)).Value = "Result"
    End If
    ' Boucle vérification
    For i = tgtStartRow To lastRowTgt
        key = ""
        For j = 1 To 4
            key = key & "|" & CStr(tgtWS.Cells(i, ColumnLetterToNumber(tgtCols(j))).Value)
        Next j
        tgtWS.Cells(i, ColumnLetterToNumber(resultCol)).Value = IIf(dict.Exists(key), "O", "N")
    Next i
    ' Sauver et fermer
    tgtWB.Save
    tgtWB.Close False
    MsgBox "Vérification terminée !", vbInformation
End Sub

' Créer bouton sur Config
Public Sub AjouterBoutonVerifier()
    Dim cfgWS As Worksheet, btn As Button
    On Error Resume Next: Set cfgWS = ThisWorkbook.Sheets("Config"): On Error GoTo 0
    If cfgWS Is Nothing Then MsgBox "Feuille 'Config' introuvable.", vbCritical: Exit Sub
    For Each btn In cfgWS.Buttons: If btn.Caption = "Exécuter Vérification" Then btn.Delete: Next btn
    With cfgWS
        Set btn = .Buttons.Add(.Range("D3").Left, .Range("D3").Top, 150, 30)
        btn.OnAction = "VerifierChamps"
        btn.Caption = "Exécuter Vérification"
        btn.Name = "btnVerifier"
    End With
End Sub

' Lettre de colonne → numéro
Private Function ColumnLetterToNumber(colLetter As String) As Long
    Dim i As Long, result As Long
    colLetter = UCase(colLetter)
    For i = 1 To Len(colLetter)
        result = result * 26 + (Asc(Mid(colLetter, i, 1)) - Asc("A") + 1)
    Next i
    ColumnLetterToNumber = result
End Function
